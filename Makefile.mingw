ifeq ($(CONFIG), debug)
  DEBUGFLAG = -g -DDEBUG -Wall -Wextra
  DEBUGNAME = debug
endif
ifeq ($(CONFIG), release)
  DEBUGFLAG = -O3 -DNDEBUG
  DEBUGNAME = release
endif

ifeq ($(BIT),64)
  BITS = 64
else
  BITS = 32
endif
OS := $(shell uname -s)
DEBUGFLAG ?= -g
DEBUGNAME ?= debug
ifeq ($(DEBUGFLAG),-O3)
  DEBUGNAME = release
endif

OBJECTPATH = $(OS)-$(BITS)-$(DEBUGNAME)

$(PATHTOROOT)/Library/$(OBJECTPATH)/%.o : $(PATHTOROOT)/Library/%.cpp
	mkdir -p $(PATHTOROOT)/Library/$(OBJECTPATH)
	$(CXX) -c $(CXXFLAGS) $< -o $@

$(OBJECTPATH)/%.o : %.cpp
	mkdir -p $(OBJECTPATH)
	$(CXX) -c $(CXXFLAGS) $< -o $@

SUPPORTOBJECTS = $(PATHTOROOT)/Library/$(OBJECTPATH)/ofxsMultiThread.o \
		 $(PATHTOROOT)/Library/$(OBJECTPATH)/ofxsInteract.o \
		 $(PATHTOROOT)/Library/$(OBJECTPATH)/ofxsProperty.o \
		 $(PATHTOROOT)/Library/$(OBJECTPATH)/ofxsLog.o \
		 $(PATHTOROOT)/Library/$(OBJECTPATH)/ofxsCore.o \
		 $(PATHTOROOT)/Library/$(OBJECTPATH)/ofxsPropertyValidation.o \
		 $(PATHTOROOT)/Library/$(OBJECTPATH)/ofxsImageEffect.o \
		 $(PATHTOROOT)/Library/$(OBJECTPATH)/ofxsParams.o 


all: $(OBJECTPATH)/$(PLUGINNAME).ofx.bundle

  ifeq ($(MINGW),1)
    LINKFLAGS = -shared -fvisibility=hidden -Xlinker --version-script=$(PATHTOROOT)/include/linuxSymbols -lopengl32 
    ARCH = Win32
    BITSFLAG = -m32
    ifeq ($(BITS), 64)
      BITSFLAG = -m64
      ARCH = Win64
    endif
    LINKFLAGS := $(LINKFLAGS) $(BITSFLAG)
  endif

  CXXFLAGS := $(DEBUGFLAG)  -I$(PATHTOROOT)/../include -I$(PATHTOROOT)/include -I$(PATHTOROOT)/Plugins/include $(BITSFLAG) -fPIC -fvisibility=hidden $(CXXFLAGS_ADD)

$(OBJECTPATH)/$(PLUGINNAME).ofx: $(addprefix $(OBJECTPATH)/,$(PLUGINOBJECTS)) $(SUPPORTOBJECTS)
	mkdir -p $(OBJECTPATH)/
	$(CXX) $^ $(LINKFLAGS) $(LDFLAGS_ADD) -o $@

$(OBJECTPATH)/$(PLUGINNAME).ofx.bundle: $(OBJECTPATH)/$(PLUGINNAME).ofx
	mkdir -p  $@/Contents/$(ARCH)
	cp  $^  $@/Contents/$(ARCH)
	cp  Info.plist  $@/Contents/
	cp manifest $@/Contents/$(ARCH)
	cp /mingw/bin/libgomp-1.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libstdc++-6.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libwinpthread-1.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libOpenColorIO.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libbz2-1.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libcairo-2.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libcroco-0.6-3.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libexpat-1.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libffi-6.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libfontconfig-1.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libfreetype-6.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libgcc_s_seh-1.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libgdk_pixbuf-2.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libgio-2.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libglib-2.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libgmodule-2.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libgobject-2.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libgomp-1.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libharfbuzz-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libiconv-2.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libintl-8.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libpango-1.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libpangocairo-1.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libpangoft2-1.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libpangowin32-1.0-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libpixman-1-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libpng16-16.dll $@/Contents/$(ARCH)
	cp /mingw/bin/librsvg-2-2.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libstdc++-6.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libtinyxml-0.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libwinpthread-1.dll $@/Contents/$(ARCH)
	cp /mingw/bin/libxml2-2.dll $@/Contents/$(ARCH)
	cp /mingw/bin/zlib1.dll $@/Contents/$(ARCH)

	(cd $@/Contents/$(ARCH) ; mt -manifest manifest -outputresource:"$(PLUGINNAME).ofx;2")
	
	if [ -n "$(RESOURCES)" ]; then mkdir -p $@/Contents/Resources; cp $(RESOURCES)  $@/Contents/Resources; fi

clean :
	rm -rf $(SUPPORTOBJECTS) $(OBJECTPATH)/ $(PATHTOROOT)/Library/$(OBJECTPATH)/ 

release :
	make DEBUGFLAG=-O3

